<html>

<head>
    <title>Mosaique</title>

    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="node_modules/itowns/examples/css/example.css">
    <link rel="stylesheet" type="text/css" href="node_modules/itowns/examples/css/LoadingScreen.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
</head>

<body>
    <div id="viewerDiv">
        <div id="menuDiv"></div>
    </div>
    <span id="divScaleWidget"> Scale </span>
    <div id="miniDiv"></div>
    <script src="node_modules/itowns/examples/js/GUI/GuiTools.js"></script>
    <script src="node_modules/itowns/dist/itowns.js"></script>
    <script src="node_modules/itowns/examples/js/GUI/LoadingScreen.js"></script>
    <script src="node_modules/itowns/dist/debug.js"></script>
    <script src="Saisie.js"></script>
    <script type="text/javascript">
        const urlParams = new URLSearchParams(window.location.search);
        const server = urlParams.get('server') ? urlParams.get('server') : 'localhost';
        const port = urlParams.get('port') ? urlParams.get('port') : 8081;
        console.log("server:", server, "port:", port)
        apiUrl = "http://" + server + ":" + port;

        itowns.Fetcher.json(apiUrl+'/json/overviews').then ((json) => {
            const overviews = json

            // limite du crs
            const crs = `${overviews.crs.type}:${overviews.crs.code}`
            const xOrigin = overviews.crs.boundingBox.xmin
            const yOrigin = overviews.crs.boundingBox.ymax

            // Define projection that we will use (taken from https://epsg.io/3946, Proj4js section)
            itowns.proj4.defs(crs, overviews.crs.proj4Definition);

            // limite du dataSet
            const xmin = overviews.dataSet.boundingBox.LowerCorner[0]
            const xmax = overviews.dataSet.boundingBox.UpperCorner[0]
            const ymin = overviews.dataSet.boundingBox.LowerCorner[1]
            const ymax = overviews.dataSet.boundingBox.UpperCorner[1]

            var placement = {
                coord: new itowns.Coordinates(crs, (xmax + xmin) * 0.5, (ymax + ymin) * 0.5),
                range: 10000,
            }

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');
            // var miniDiv = document.getElementById('miniDiv');

            // Define geographic extent of level 0 : CRS, min/max X, min/max Y
            const resolutionLv0 = overviews.resolution * 2 ** overviews.level.max;
            
            var extent = new itowns.Extent(
                crs,
                xOrigin, xOrigin + ( overviews.tileSize.width * resolutionLv0),
                yOrigin - ( overviews.tileSize.height * resolutionLv0), yOrigin);

            // Instanciate PlanarView*
            view = new itowns.PlanarView(viewerDiv, extent, {
                placement,
                maxSubdivisionLevel: 30,
                //  disableSkirt: false 
            });
            setupLoadingScreen(viewerDiv, view);

            view.isDebugMode = true;
            setupLoadingScreen(viewerDiv, view);
            menuGlobe = new GuiTools('menuDiv', view);
            menuGlobe.gui.width = 300;

            var orthoLayer, graphLayer, opiLayer;
            var orthoConfig, graphConfig, opiConfig;
             
            const config = {};
            ['ortho', 'graph', 'opi'].forEach((layerName) => {

                config[layerName] = {
                    id: layerName,
                    source: {
                        url: apiUrl+'/wmts',
                        projection: crs,
                        format: 'image/png',
                        name: layerName,
                        tileMatrixSet: overviews.identifier,
                        tileMatrixSetLimits: overviews.dataSet.limits
                    }
                }

                config[layerName].source = new itowns.WMTSSource(config[layerName].source);
                config[layerName].source.extentInsideLimit = function (extent) {
                    return true;
                }

            });
            config.graph.opacity = 0.2;
            config.opi.opacity = 0.2;
            orthoLayer = new itowns.ColorLayer('Ortho', config.ortho);
            view.addLayer(orthoLayer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            graphLayer = new itowns.ColorLayer('Graph', config.graph);
            view.addLayer(graphLayer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            opiLayer = new itowns.ColorLayer('Opi', config.opi);
            opiLayer.visible = false
            view.addLayer(opiLayer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            itowns.ColorLayersOrdering.moveLayerToIndex(view, 'Ortho', 0);
            itowns.ColorLayersOrdering.moveLayerToIndex(view, 'Opi', 1);
            itowns.ColorLayersOrdering.moveLayerToIndex(view, 'Graph', 2);

            graphConfig=config.graph
            orthoConfig=config.ortho
            opiConfig=config.opi

            var saisie = new Saisie({ graphLayer, orthoLayer, graphConfig, orthoConfig, opiLayer, opiConfig, apiUrl });
            saisie.cliche = 'unknown';
            saisie.message = '';
            menuGlobe.gui.add(saisie, 'select');
            menuGlobe.gui.add(saisie, 'cliche').listen();
            menuGlobe.gui.add(saisie, 'polygon');
            // menuGlobe.gui.add(saisie, 'freehand');
            menuGlobe.gui.add(saisie, 'undo');
            menuGlobe.gui.add(saisie, 'redo');
            menuGlobe.gui.add(saisie, 'clear');
            menuGlobe.gui.add(saisie, 'message').listen();
            
            viewerDiv.focus();
            viewerDiv.addEventListener('mousemove', function (ev) {
                ev.preventDefault();
                saisie.mousemove(ev);
                return false;
            }, false);
            viewerDiv.addEventListener('click', function (ev) {
                ev.preventDefault();
                saisie.click(ev);
                return false;
            }, false);
            viewerDiv.addEventListener('mousedown', function (ev) {
                ev.preventDefault();
                saisie.mousedown(ev);
                return false;
            }, false);
            viewerDiv.addEventListener('mouseup', function (ev) {
                ev.preventDefault();
                saisie.mouseup(ev);
                return false;
            }, false);

            // instanciate controls
            // eslint-disable-next-line no-new
            new itowns.PlanarControls(view, {
                maxAltitude: 80000000,
                enableRotation: false
            });

            // Request redraw
            view.notifyChange();

            menuGlobe.addImageryLayersGUI(view.getLayers(function gui(l) { return l.isColorLayer; }));
            debug.createTileDebugUI(menuGlobe.gui, view);
        })
    </script>
</body>
</html>